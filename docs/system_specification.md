# 台帳管理システム (Ledger System) 仕様書

## 1. システム概要
本システムは、社内で貸与される各種デバイス（iPhone, ガラホ, タブレット, ルーター）およびそれに関連するマスタデータ（社員, エリア, 住所）を一元管理するためのWebアプリケーションです。
管理者向けのデバイス管理・監査機能と、一般ユーザー向けの参照機能を備えています。

## 2. ユーザー権限 (Roles)

| 権限 | 識別子 | 説明 |
|---|---|---|
| **管理者** | `admin` | 全機能にアクセス可能。データの登録・編集・削除・インポート・エクスポート、および監査ログの閲覧が可能。 |
| **一般** | `user` | 自身のダッシュボード閲覧、および一部データの参照のみ可能（要件により変動）。今回は主に管理者機能を中心に実装。 |

## 3. 画面一覧と機能詳細

### 3.1 認証系 (`/login`)
- **ログイン機能**: 社員コードとパスワードによる認証。
- **セッション管理**: Supabase Auth を利用し、Cookie/JWT によるセッション維持を行う。

### 3.2 ダッシュボード (`/dashboard`)
- **システム概要表示**: 管理されている重要デバイスのステータスやアラートを表示（システムアラート）。
- **メニュー**: サイドバーにより各管理画面へ遷移可能。

### 3.3 デバイス管理
以下の4種類のデバイスを管理します。各画面で共通して **検索・ソート・CSV操作** が可能です。

#### ① iPhone 管理 (`/devices/iphones`)
- **一覧表示**: 管理番号、モデル名、電話番号、使用者（社員）、貸出日、返却日等の表示。
- **登録・編集**: モーダルフォームによるデータの新規登録・更新。
- **削除**: 個別削除および一括削除（チェックボックス選択）。削除時は確認ダイアログを表示。
- **一括操作**:
  - **CSVエクスポート**: 現在の検索条件に一致するデータをCSV出力。
  - **CSVインポート**: 専用フォーマットによる一括登録・更新。
  - **テンプレートDL**: インポート用の雛形CSVダウンロード。

#### ② ガラホ (Feature Phone) 管理 (`/devices/feature-phones`)
- **機能**: iPhone管理と同等の機能（一覧、検索、CRUD、CSV操作）。
- **特徴**: コスト負担元などのガラホ固有項目を管理。

#### ③ 勤怠タブレット管理 (`/devices/tablets`)
- **機能**: iPhone管理と同等の機能。
- **特徴**: 設置場所（拠点・住所）との紐付けを重視。

#### ④ Wi-Fiルーター管理 (`/devices/routers`)
- **機能**: iPhone管理と同等の機能。
- **特徴**: SSID、パスワード、データ容量、契約プランなどの通信詳細を管理。

#### ⑤ マニュアル管理 (`/device-manuals`)
- **一覧・登録**: デバイス利用マニュアル（PDF等）のアップロードと管理（予定/簡易実装）。

### 3.4 マスタ管理
デバイス情報が参照する基礎データを管理します。

#### ① 社員マスタ (`/masters/employees`)
- **一覧表示**: 社員コード、氏名、所属、役職、権限(admin/user)等の管理。
- **機能**: 新規採用・退職に伴う登録・削除・編集。
- **認証連携**: 社員登録時に自動的に認証ユーザー(Auth)も作成される（パスワード設定あり）。

#### ② エリアマスタ (`/masters/areas`)
- **一覧表示**: 拠点エリアコード、エリア名の管理。
- **機能**: 地域の統廃合に伴うメンテナンス。

#### ③ 住所マスタ (`/masters/addresses`)
- **一覧表示**: 各拠点の詳細住所、電話番号、担当者情報。
- **機能**: 拠点移転や新設に伴うメンテナンス。CSVインポート対応。

### 3.5 監査・システム (`/logs`, `/audit/reports`)

#### ① 監査ログ (`/logs`)
- **目的**: 「誰が」「いつ」「何を」「どうしたか」を追跡し、不正や誤操作を特定する。
- **機能**:
  - **ログ一覧**: 操作履歴の時系列表示。
  - **フィルター**: 期間、実行者、アクション種別（登録/更新/削除/ログイン等）、対象機能での絞り込み。
  - **CSVエクスポート**: 監査対応用の全ログ出力。
  - **詳細表示**: アクションの結果（成功/失敗）や変更内容の詳細（Metadata）を確認。

#### ② 監査レポート (`/audit/reports`) (管理者専用)
- **目的**: ログの傾向分析と異常検知のサマリ確認。
- **機能**:
  - **日次/週次レポート**: 自動生成されたレポートの閲覧。
  - **詳細確認**: アクション別件数、エラー数、異常検知（Anomaly）のハイライト表示。
  - **ログ連携**: レポート期間に該当するログ一覧へワンクリックで遷移。

## 4. 共通仕様・技術スタック

### UI/UX
- **確認ダイアログ**: 削除などの重要操作時には、誤操作防止のため確認モーダル (`useConfirm`) を表示。
- **レスポンシブ**: PCでの管理業務を主とするが、タブレット等でも閲覧可能なレイアウト。
- **統一デザイン**: すべての管理画面で統一された操作感（ヘッダー、検索バー、ボタン配置）を提供。

### 技術基盤
- **Frontend**: Next.js (App Router), React, TypeScript, Tailwind CSS
- **Backend/DB**: Supabase (PostgreSQL, Auth, Realtime)
- **Log System**:
  - 管理者による操作はサーバー側で直接DB保存（RLS回避）し、確実な記録を保証。
  - 単位時間あたりの過剰アクセス等を検知する異常検知ロジック搭載。
- **Batch**: pg_cron による日次レポート生成・通知等はデータベース側で自律的に実行。

---
**補足**: すべての機能は「運用時の安全性（誤削除防止）」と「トレーサビリティ（監査ログ）」を重視して設計されています。
